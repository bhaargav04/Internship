{% extends 'base.html' %}
{% block content %}
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="fw-bold" style="color: var(--color2); margin-left: 30%;">
      Tax Report for {{ employee.user.username }}
    </h2>
    <a href="{% url 'hr_dashboard' %}" class="btn btn-sm btn-outline-danger">
      Back to Dashboard
    </a>
  </div>

  <!-- ðŸ”¥ Employee Tax Summary -->
  <div class="card shadow-lg border-0 rounded-4 p-4 mb-4" style="max-width: 1000px; margin: auto;">
    <h5 class="fw-semibold mb-3 text-center">Employee Financial Summary</h5>
    <div class="row text-center">
      <div class="col-md-4 mb-3">
        <h6 class="text-muted">Basic Salary</h6>
        <h5 class="fw-bold text-primary">â‚¹{{ employee.BasicSalary }}</h5>
      </div>
      <div class="col-md-4 mb-3">
        <h6 class="text-muted">Gross Salary</h6>
        <h5 class="fw-bold text-success">â‚¹{{ employee.Salary }}</h5>
      </div>
      <!-- <div class="col-md-4 mb-3">
        <h6 class="text-muted">Dearness Allowance</h6>
        <h5 class="fw-bold text-info">â‚¹{{ employee.DearnessAllowance }}</h5>
      </div> -->
      <div class="col-md-4 mb-3">
        <h6 class="text-muted">Total Utilized</h6>
        <h5 class="fw-bold text-info">â‚¹{{ total_utilized }}</h5>
      </div>
      <div class="col-md-4 mb-3">
        <h6 class="text-muted">Total Remaining</h6>
        <h5 class="fw-bold text-warning">â‚¹{{ total_remaining }}</h5>
      </div>
      <div class="col-md-4 mb-3">
        <h6 class="text-muted">Savings (Old Regime)</h6>
        <h5 class="fw-bold text-success">â‚¹{{ employee.tax_old }}</h5>
      </div>
      <div class="col-md-4 mb-3">
        <h6 class="text-muted">Savings (New Regime)</h6>
        <h5 class="fw-bold text-success">â‚¹{{ employee.tax_new }}</h5>
      </div>
    </div>
  </div>

  <!-- ðŸ“ˆ Area Chart -->
  <div class="card shadow-lg border-0 rounded-4 p-4 mb-4" style="max-width: 950px; margin: auto;">
    <h5 class="text-center fw-semibold mb-3">Category-Wise Utilization Trend</h5>
    <canvas id="areaChart" style="height: 400px;"></canvas>
  </div>

  <!-- ðŸ© Doughnut + ðŸ“Š Grouped Bar -->
  <div class="row">
    <div class="col-md-6">
      <div class="card shadow-lg border-0 rounded-4 p-4 mb-4">
        <h5 class="text-center fw-semibold mb-3">Overall Utilization</h5>
        <canvas id="doughnutChart" style="height: 350px;"></canvas>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card shadow-lg border-0 rounded-4 p-4 mb-4">
        <h5 class="text-center fw-semibold mb-3">Utilization Comparison</h5>
        <canvas id="barChart" style="height: 350px;"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- DATA -->
{{ labels|json_script:"labels-data" }}
{{ utilized|json_script:"utilized-data" }}
{{ remaining|json_script:"remaining-data" }}
{{ total_utilized|json_script:"total-utilized-data" }}
{{ total_remaining|json_script:"total-remaining-data" }}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const labels = JSON.parse(document.getElementById('labels-data').textContent);
const utilized = JSON.parse(document.getElementById('utilized-data').textContent);
let remaining = JSON.parse(document.getElementById('remaining-data').textContent);
let totalUtilized = JSON.parse(document.getElementById('total-utilized-data').textContent);
let totalRemaining = JSON.parse(document.getElementById('total-remaining-data').textContent);

// ðŸ”¥ Recalculate Remaining (No Negatives)
remaining = utilized.map((val, i) => Math.max(0, remaining[i]));
totalRemaining = Math.max(0, totalRemaining);

// === Area Chart ===
const ctxArea = document.getElementById('areaChart').getContext('2d');
const gradient = ctxArea.createLinearGradient(0, 0, 0, 400);
gradient.addColorStop(0, 'rgba(54,162,235,0.4)');
gradient.addColorStop(1, 'rgba(54,162,235,0)');

new Chart(ctxArea, {
  type: 'line',
  data: {
    labels: labels,
    datasets: [{
      label: 'Utilization Trend',
      data: utilized,
      fill: true,
      backgroundColor: gradient,
      borderColor: 'rgba(54,162,235,1)',
      borderWidth: 2,
      tension: 0.3,
      pointRadius: 4,
      pointBackgroundColor: 'rgba(54,162,235,1)'
    }]
  },
  options: {
    responsive: true,
    plugins: { legend: { display: false } },
    scales: {
      x: { grid: { display: false } },
      y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.05)' } }
    }
  }
});

// === Doughnut Chart ===
new Chart(document.getElementById('doughnutChart').getContext('2d'), {
  type: 'doughnut',
  data: {
    labels: ['Total Utilized', 'Total Remaining'],
    datasets: [{
      data: [totalUtilized, totalRemaining],
      backgroundColor: ['rgba(54,162,235,0.7)', 'rgba(255,206,86,0.7)'],
      borderColor: ['rgba(54,162,235,1)', 'rgba(255,206,86,1)'],
      borderWidth: 1
    }]
  },
  options: { plugins: { legend: { position: 'bottom' } } }
});

// === Bar Chart ===
new Chart(document.getElementById('barChart').getContext('2d'), {
  type: 'bar',
  data: {
    labels: labels,
    datasets: [
      {
        label: 'Utilized',
        data: utilized,
        backgroundColor: 'rgba(54,162,235,0.7)',
        borderColor: 'rgba(54,162,235,1)',
        borderWidth: 1
      },
      {
        label: 'Remaining',
        data: remaining,
        backgroundColor: 'rgba(255,206,86,0.7)',
        borderColor: 'rgba(255,206,86,1)',
        borderWidth: 1
      }
    ]
  },
  options: {
    responsive: true,
    plugins: { legend: { position: 'bottom' } },
    scales: {
      x: { grid: { display: false } },
      y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.05)' } }
    }
  }
});
</script>
{% endblock %}
