{% extends 'base.html' %}
{% block content %}
<div class="container py-4">
    <h2 class="text-center mb-4" style="color: var(--color2); font-weight: 800;">
        Tax Report for {{ employee.user.username }}
    </h2>

   <!-- Replace the Stacked Bar Chart Card -->
<div class="card shadow-sm p-4 mb-4" style="max-width: 900px; margin: auto;">
    <h5 class="mb-3 text-center">Category-wise Utilization Pulse</h5>
    <canvas id="pulseChart" style="height: 350px;"></canvas>
</div>


    <!-- Doughnut and Radar Charts Side by Side -->
    <div class="row">
        <div class="col-md-6">
            <div class="card shadow-sm p-4 mb-4">
                <h5 class="mb-3 text-center">Overall Utilization</h5>
                <canvas id="doughnutChart" style="height: 300px;"></canvas>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card shadow-sm p-4 mb-4">
                <h5 class="mb-3 text-center">Utilization Radar</h5>
                <canvas id="radarChart" style="height: 300px; max-height: 400px;"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Pass data to JS safely -->
{{ labels|json_script:"labels-data" }}
{{ utilized|json_script:"utilized-data" }}
{{ remaining|json_script:"remaining-data" }}
{{ total_utilized|json_script:"total-utilized-data" }}
{{ total_remaining|json_script:"total-remaining-data" }}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const labels = JSON.parse(document.getElementById('labels-data').textContent);
const utilized = JSON.parse(document.getElementById('utilized-data').textContent);
const remaining = JSON.parse(document.getElementById('remaining-data').textContent);
const totalUtilized = JSON.parse(document.getElementById('total-utilized-data').textContent);
const totalRemaining = JSON.parse(document.getElementById('total-remaining-data').textContent);

const pulseCtx = document.getElementById('pulseChart').getContext('2d');
new Chart(pulseCtx, {
    type: 'line',
    data: {
        labels: labels,
        datasets: [{
            label: 'Utilized vs Remaining',
            data: utilized, // you can combine or choose another metric for the pulse effect
            fill: true,
            backgroundColor: 'rgba(54, 162, 235, 0.2)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 2,
            tension: 0.4, // smooth line; set 0 for sharp spikes like trading charts
            pointRadius: 0 // hides the points for a cleaner pulse look
        }]
    },
    options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: {
            x: {
                grid: { display: false }
            },
            y: {
                beginAtZero: true,
                grid: { drawBorder: false }
            }
        },
        elements: {
            line: {
                borderJoinStyle: 'round'
            }
        }
    }
});

// --- Doughnut Chart ---
const doughnutCtx = document.getElementById('doughnutChart').getContext('2d');
new Chart(doughnutCtx, {
    type: 'doughnut',
    data: {
        labels: ['Total Utilized', 'Total Remaining'],
        datasets: [{
            data: [totalUtilized, totalRemaining],
            backgroundColor: ['rgba(54, 162, 235, 0.7)', 'rgba(255, 206, 86, 0.7)'],
            borderColor: ['rgba(54, 162, 235, 1)', 'rgba(255, 206, 86, 1)'],
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        plugins: { legend: { position: 'top' } }
    }
});

// --- Radar Chart ---
const radarCtx = document.getElementById('radarChart').getContext('2d');
new Chart(radarCtx, {
    type: 'radar',
    data: {
        labels: labels,
        datasets: [
            {
                label: 'Utilized',
                data: utilized,
                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 2
            },
            {
                label: 'Remaining',
                data: remaining,
                backgroundColor: 'rgba(255, 206, 86, 0.2)',
                borderColor: 'rgba(255, 206, 86, 1)',
                borderWidth: 2
            }
        ]
    },
    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' } } }
});
</script>
{% endblock %}
